<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Intipalka Mystery: El Ahorcado</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Bangers&family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root {
            --wine: #6b1021; 
            --gold: #c5a059;
            --success: #22c55e; 
            --error: #dc3545;
            --card-bg: rgba(255, 255, 255, 0.94);
        }
        
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
          background: linear-gradient(180deg,rgba(39, 39, 39, 0.86) 0%, rgba(240, 239, 236, 0.72) 58%);
        }

        /* --- VIDEO DE FONDO --- */
        #bg-video {
            position: fixed;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -100;
            transform: translateX(-50%) translateY(-50%);
            object-fit: cover;
            filter: brightness(0.4);
        }

        .game-wrapper { width: 100%; max-width: 500px; padding: 15px; z-index: 10; position: relative; }

        /* Logo animado y centrado */
        .logo-container img {
            max-height: 110px;
            margin-bottom: 10px;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
            animation: pulseLogo 3s infinite ease-in-out;
        }
        @keyframes pulseLogo { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        h1 { 
            font-family: 'Bangers', cursive; 
            font-size: 2.8rem; 
            color: #fff; 
            text-shadow: 2px 2px 0 var(--wine);
            margin-bottom: 15px;
        }

        .screen { display: none; flex-direction: column; align-items: center; }
        .active { display: flex; }
        
        .glass-card { 
            background: var(--card-bg); 
            padding: 1.5rem; 
            border-radius: 30px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); 
            border: 3px solid var(--gold); 
            width: 100%; 
        }

        /* Ahorcado SVG */
        #hangman-svg { height: 130px; margin: 5px 0; }
        .hangman-part { opacity: 0; stroke: var(--wine); stroke-width: 7; fill: none; transition: opacity 0.3s; stroke-linecap: round; }
        .visible { opacity: 1 !important; }

        /* Teclado Responsivo */
        #keyboard { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; width: 100%; margin-top: 15px; }
        .key { 
            background: #fff; color: var(--wine); padding: 10px 0; border-radius: 10px; 
            cursor: pointer; font-size: 1rem; font-weight: 700; box-shadow: 0 4px 0 #bbb;
            border: 1px solid #ddd; transition: 0.1s; user-select: none;
        }
        .key:active { transform: translateY(2px); box-shadow: 0 0 0 #bbb; }
        .key.used { opacity: 0.3; pointer-events: none; }
        .key.correct { background: var(--success) !important; color: white; border: none; box-shadow: 0 4px 0 #157347; }
        .key.wrong { background: var(--error) !important; color: white; border: none; box-shadow: 0 4px 0 #a52834; }

        #word-display { font-size: 1.8rem; margin: 15px 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        .letter-slot { border-bottom: 4px solid var(--gold); min-width: 25px; height: 35px; font-weight: 700; color: var(--wine); }
        .space-slot { border-bottom: none; width: 10px; }
        
        #timer-box { font-size: 2.5rem; font-family: 'Bangers'; color: var(--error); text-shadow: 1px 1px #000; }
        
        .main-btn { 
            background: var(--wine); color: white; border: none; padding: 15px; 
            font-size: 1.4rem; border-radius: 50px; font-family: 'Luckiest Guy';
            box-shadow: 0 6px 0 #400; width: 100%; transition: 0.2s;
        }

        /* Efecto Pánico */
        #panic-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 0, 0); z-index: 5; pointer-events: none; transition: 0.5s;
        }
        .panic-active { animation: panic-pulse 0.6s infinite alternate; }
        @keyframes panic-pulse { from { background: rgba(0,0,0,0); } to { background: rgba(107, 16, 33, 0.3); } }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
    </style>
</head>
<body>

<video autoplay muted loop playsinline id="bg-video">
    <source src="video/fondo-intipalka.mp4" type="video/mp4">
</video>

<audio id="bg-music" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3" type="audio/mpeg">
</audio>

<div id="panic-overlay"></div>

<div class="game-wrapper">
    <div class="logo-container text-center animate__animated animate__fadeInDown">
        <img src="image/intipalka-logo.png" alt="Intipalka">
    </div>

    <div id="start-screen" class="screen active">
        <div class="glass-card text-center">
            <h1>MISTERIO</h1>
            <p id="status" class="small mb-3 text-muted">CONECTANDO BODEGA...</p>
            <div id="auth-ui">
                <input type="text" id="player-name" class="form-control text-center mb-3" placeholder="TU NOMBRE" style="border-radius: 15px; height: 50px;">
                <button class="main-btn" onclick="handleAuth()">ENTRAR</button>
            </div>
            <div id="welcome-ui" style="display: none;">
                <h2 id="user-greeting" style="color: var(--wine);"></h2>
                <p id="user-stats" class="small mb-4 text-dark"></p>
                <button class="main-btn" onclick="startGame()">¡EMPEZAR JUEGO!</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="glass-card text-center">
            <div id="timer-box">60</div>
            <p id="hint-text" class="text-uppercase small fw-bold text-muted mb-2"></p>
            
            <svg id="hangman-svg" viewBox="0 0 100 150">
                <path d="M10 140 L90 140 M30 140 L30 10 L70 10 L70 30" stroke="#444" stroke-width="5" fill="none"/>
                <circle class="hangman-part" cx="70" cy="40" r="10" />
                <line class="hangman-part" x1="70" y1="50" x2="70" y2="90" />
                <line class="hangman-part" x1="70" y1="60" x2="50" y2="80" />
                <line class="hangman-part" x1="70" y1="60" x2="90" y2="80" />
                <line class="hangman-part" x1="70" y1="90" x2="55" y2="120" />
                <line class="hangman-part" x1="70" y1="90" x2="85" y2="120" />
            </svg>

            <div id="word-display"></div>
            <div id="keyboard"></div>
        </div>
    </div>
</div>

<div id="result-modal" class="modal">
    <div class="glass-card text-center m-4">
        <h2 id="res-title" style="font-family: 'Bangers'; font-size: 3rem;"></h2>
        <p id="res-msg" class="fs-5 mb-4"></p>
        <button class="main-btn" onclick="location.reload()">REINTENTAR</button>
    </div>
</div>

<script>
    const SHEET_ID = "1jQuYHBi8t2xUP0nua1yLPGHQr2WOWwq0G-S0uf0Xqgc";
    const WEB_APP_URL = "https://script.google.com/macros/s/1F014550G-9AsTsKQ-NdlRT-R_ejdDuc-RczpXijCMll7SiM98iLDue4p/exec";

    let wordsDB = [], selectedWord, currentHint, guessedLetters = [], errors = 0, playerName;
    let timeLeft, timerInterval;
    const music = document.getElementById('bg-music');

    async function loadWords() {
        try {
            const r = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`);
            const data = await r.text();
            wordsDB = data.split('\n').map(row => {
                const c = row.split(',');
                return { p: c[0]?.trim().toUpperCase(), h: c[1]?.trim() || "Pista misteriosa" };
            }).filter(i => i.p);
            document.getElementById('status').innerText = "BODEGA CONECTADA ✨";
        } catch (e) { document.getElementById('status').innerText = "ERROR DE CARGA"; }
    }

    async function handleAuth() {
        playerName = document.getElementById('player-name').value.trim().toUpperCase();
        if(!playerName) return;
        
        document.getElementById('status').innerText = "VERIFICANDO...";
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tq=` + 
                    encodeURIComponent(`SELECT COUNT(C) WHERE B = '${playerName}' AND C = 'GANÓ'`);
        
        try {
            const r = await fetch(url); const t = await r.text();
            const json = JSON.parse(t.substr(47).slice(0, -2));
            const wins = json.table.rows[0]?.c[0]?.v || 0;
            
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('welcome-ui').style.display = 'block';
            document.getElementById('user-greeting').innerText = `HOLA ${playerName}!`;
            document.getElementById('user-stats').innerText = `Llevas ${wins} victorias acumuladas.`;
        } catch(e) { startGame(); }
    }

    function startGame() {
        // Iniciar música
        music.volume = 0.4;
        music.play();

        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('game-screen').classList.add('active');
        
        const item = wordsDB[Math.floor(Math.random() * wordsDB.length)];
        selectedWord = item.p; currentHint = item.h;
        guessedLetters = [" "]; errors = 0;
        
        document.getElementById('hint-text').innerText = "PISTA: " + currentHint;
        timeLeft = 60;
        updateDisplay();
        createKeyboard();

        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer-box').innerText = timeLeft;
            if(timeLeft <= 10) {
                document.getElementById('panic-overlay').classList.add('panic-active');
            }
            if(timeLeft <= 0) endGame(false);
        }, 1000);
    }

    function updateDisplay() {
        const container = document.getElementById('word-display');
        container.innerHTML = selectedWord.split('').map(char => {
            if(char === " ") return `<span class="letter-slot space-slot"></span>`;
            return `<span class="letter-slot d-flex align-items-center justify-content-center">${guessedLetters.includes(char) ? char : ''}</span>`;
        }).join('');
        
        if(selectedWord.split('').every(l => guessedLetters.includes(l))) {
            setTimeout(() => endGame(true), 400);
        }
    }

    function createKeyboard() {
        const keys = "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ".split('');
        document.getElementById('keyboard').innerHTML = keys.map(l => `<div class="key" onclick="check('${l}', this)">${l}</div>`).join('');
    }

    function check(l, btn) {
        if(btn.classList.contains('used')) return;
        btn.classList.add('used');
        
        if(selectedWord.includes(l)) {
            guessedLetters.push(l); 
            btn.classList.add('correct');
            updateDisplay();
        } else {
            const parts = document.querySelectorAll('.hangman-part');
            if(parts[errors]) parts[errors].classList.add('visible');
            errors++; 
            btn.classList.add('wrong');
            if(errors >= 6) setTimeout(() => endGame(false), 500);
        }
    }

    function endGame(won) {
        clearInterval(timerInterval);
        
        // Efecto fade out para la música
        let fade = setInterval(() => {
            if (music.volume > 0.05) music.volume -= 0.05;
            else { music.pause(); clearInterval(fade); }
        }, 100);

        document.getElementById('panic-overlay').classList.remove('panic-active');
        document.getElementById('result-modal').style.display = 'flex';
        
        const title = document.getElementById('res-title');
        title.innerText = won ? "¡LOGRADO!" : "ATRAPADO";
        title.style.color = won ? "var(--success)" : "var(--error)";
        document.getElementById('res-msg').innerText = `La respuesta era: ${selectedWord}`;
        
        if(won) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        const data = { fecha: new Date().toLocaleString(), nombre: playerName, resultado: won ? "GANÓ" : "PERDIÓ", palabra: selectedWord };
        fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
    }

    window.onload = loadWords;
</script>
</body>
</html>